<div class="operand-selector" x-data="{ type: 'field' }">
    <div class="operand-input-group">
        <!-- Toggle button -->
        <button type="button" 
                @click="type = (type === 'field' ? 'value' : 'field')"
                class="operand-toggle"
                :title="type === 'field' ? 'Switch to value' : 'Switch to field'">
            <span x-show="type === 'field'">üìä</span>
            <span x-show="type === 'value'">‚úèÔ∏è</span>
        </button>
        
        <!-- Single input area that morphs -->
        <div class="operand-input">
            <!-- Field selector -->
            <select x-show="type === 'field'" 
                    name="{{ side }}_field" 
                    :required="type === 'field'"
                    :disabled="type !== 'field'"
                    x-cloak
                    {% if side == "left" %}
                    hx-get="/rule/conditions/operators-and-right"
                    hx-target="#operator-group"
                    hx-swap="innerHTML"
                    hx-include="[name='left_type'], [name='left_field']"
                    @change="
                        const numericFields = ['transaction_amount', 'user_age', 'transaction_count24h', 'account_age'];
                        leftFieldType = numericFields.includes($event.target.value) ? 'number' : 'string';
                    "
                    {% endif %}>
                <option value="">Select a field...</option>
                {% for field in fields %}
                <option value="{{ field.as_str() }}"
                        {% if side == "right" %}
                        x-show="!leftFieldType || 
                                (leftFieldType === 'number' && ['transaction_amount', 'user_age', 'transaction_count24h', 'account_age'].includes('{{ field.as_str() }}')) ||
                                (leftFieldType === 'string' && !['transaction_amount', 'user_age', 'transaction_count24h', 'account_age'].includes('{{ field.as_str() }}'))"
                        {% endif %}>
                    {{ field.display_name() }}
                </option>
                {% endfor %}
            </select>
            
            <!-- Value input (adapts based on left field type for right side) -->
            {% if side == "right" %}
            <input x-show="type === 'value' && leftFieldType === 'number'" 
                   type="number" 
                   name="{{ side }}_value" 
                   placeholder="Enter a number..."
                   step="any"
                   :required="type === 'value' && leftFieldType === 'number'"
                   :disabled="type !== 'value' || leftFieldType !== 'number'"
                   x-cloak>
            <input x-show="type === 'value' && leftFieldType !== 'number'" 
                   type="text" 
                   name="{{ side }}_value" 
                   placeholder="Enter value..."
                   :required="type === 'value' && leftFieldType !== 'number'"
                   :disabled="type !== 'value' || leftFieldType === 'number'"
                   x-cloak>
            {% else %}
            <input x-show="type === 'value'" 
                   type="text" 
                   name="{{ side }}_value" 
                   placeholder="Enter value..."
                   :required="type === 'value'"
                   :disabled="type !== 'value'"
                   x-cloak
                   {% if side == "left" %}
                   hx-get="/rule/conditions/operators-for-value"
                   hx-target="#operator-group"
                   hx-swap="innerHTML"
                   hx-trigger="input changed delay:200ms"
                   hx-include="[name='left_type'], [name='left_value']"
                   @input="
                       const val = $event.target.value;
                       if (val === '') {
                           leftFieldType = null;
                       } else if (!isNaN(val) && val.trim() !== '') {
                           leftFieldType = 'number';
                       } else {
                           leftFieldType = 'string';
                       }
                   "
                   {% endif %}>
            {% endif %}
        </div>
    </div>
    
    <!-- Hidden input to track the type for form submission -->
    <input type="hidden" name="{{ side }}_type" :value="type">
</div>

<style>
.operand-input-group {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.operand-toggle {
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: white;
    cursor: pointer;
    font-size: 1.2rem;
    transition: all 0.2s;
}

.operand-toggle:hover {
    background: #f0f0f0;
    transform: scale(1.1);
}

.operand-input {
    flex: 1;
}

.operand-input select,
.operand-input input {
    width: 100%;
}

/* Hide elements before Alpine loads */
[x-cloak] { display: none !important; }
</style>

